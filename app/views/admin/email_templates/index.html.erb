<main class="container mx-auto px-4 py-8" role="main" id="main-content">
  <div class="max-w-7xl mx-auto">
    <%# Skip to content link %>
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:p-4 focus:bg-white focus:z-50">
      Skip to main content
    </a>

    <%# Header Section %>
    <div class="mb-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-3xl font-bold" id="page-title">
          Email Templates
        </h1>
        <div class="flex gap-2">
          <%= button_to bulk_disable_admin_email_templates_path, method: :patch, class: "px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-red-600 text-sm font-medium", data: { confirm: "Disable all email templates? They will not be sent until re-enabled." } do %>
            Disable All
          <% end %>
          <%= button_to bulk_enable_admin_email_templates_path, method: :patch, class: "px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-green-600 text-sm font-medium", data: { confirm: "Enable all email templates? They will be sent to users." } do %>
            Enable All
          <% end %>
        </div>
      </div>
    </div>

    <%# Templates Table Section %>
    <section aria-labelledby="templates-heading" class="bg-white rounded-lg shadow mb-6">
      <h2 id="templates-heading" class="sr-only">Email Templates List</h2>

      <div class="overflow-x-auto">
        <% if @email_templates.present? %>
          <div class="hidden md:block"> <%# Desktop version %>
            <table class="min-w-full table-fixed divide-y divide-gray-200" aria-label="Email templates">
              <caption class="sr-only">List of email templates</caption>
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2 lg:w-[45%]">
                    Template Purpose
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4 lg:w-[20%]">
                    Email Subject
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32 lg:w-32">
                    Template ID
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">
                    Ver.
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">
                    Status
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">
                    Updated
                  </th>
                  <th scope="col" class="relative px-6 py-3 w-32">
                    <span class="sr-only">Actions</span>
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <% @email_templates.each do |template| %>
                  <% template_def = EmailTemplate::AVAILABLE_TEMPLATES[template.name.to_sym] || {} %>
                  <% full_description = template_def[:description].present? ? template_def[:description] : template.description.presence || "No description available" %>
                  <tr>
                    <th scope="row" class="px-6 py-4 text-sm text-gray-600">
                      <div class="group relative cursor-help line-clamp-3" tabindex="0" aria-describedby="desc-<%= template.id %>">
                        <span class="sr-only"><%= full_description %></span>
                        <%= truncate(full_description, length: 140) %>
                        <div id="desc-<%= template.id %>" role="tooltip" class="absolute invisible group-hover:visible group-focus:visible bg-white border border-gray-200 shadow-lg rounded-md p-3 z-10 w-96 mt-1 text-sm max-w-prose">
                          <%= full_description %>
                        </div>
                      </div>
                      <div class="text-xs text-gray-500 mt-1"><%= template.format.titleize %></div>
                    </th>
                    <td class="px-6 py-4 text-sm text-gray-600">
                      <div class="line-clamp-2">
                        <%= template.subject.present? ? template.subject : "No subject" %>
                      </div>
                    </td>
                    <td class="px-6 py-4 text-sm font-mono text-gray-600 max-w-[10rem] truncate break-all">
                      <%= template.name %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                      <%= template.version %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <% if template.enabled %>
                        <span class="inline-flex items-center rounded-full bg-green-100 px-3 py-1 text-xs font-medium text-green-800">
                          Enabled
                        </span>
                      <% else %>
                        <span class="inline-flex items-center rounded-full bg-red-100 px-3 py-1 text-xs font-medium text-red-800">
                          Disabled
                        </span>
                      <% end %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                      <%= time_ago_in_words(template.updated_at) %> ago
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                      <%= link_to 'View', admin_email_template_path(template), class: "text-indigo-600 hover:text-indigo-900 focus-visible:outline focus-visible:outline-2 focus-visible:outline-indigo-600", aria: { label: "View #{template.name} template" } %>
                      <%= link_to 'Edit', edit_admin_email_template_path(template), class: "text-indigo-600 hover:text-indigo-900 focus-visible:outline focus-visible:outline-2 focus-visible:outline-indigo-600", aria: { label: "Edit #{template.name} template" } %>
                      <% if template.enabled %>
                        <%= button_to 'Disable', toggle_disabled_admin_email_template_path(template), method: :patch, class: "text-red-600 hover:text-red-900 focus-visible:outline focus-visible:outline-2 focus-visible:outline-red-600 inline", aria: { label: "Disable #{template.name} template" } %>
                      <% else %>
                        <%= button_to 'Enable', toggle_disabled_admin_email_template_path(template), method: :patch, class: "text-green-600 hover:text-green-900 focus-visible:outline focus-visible:outline-2 focus-visible:outline-green-600 inline", aria: { label: "Enable #{template.name} template" } %>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <%# Mobile-friendly card layout %>
          <div class="md:hidden">
            <ul role="list" class="divide-y divide-gray-200 space-y-4">
              <% @email_templates.each do |template| %>
                <% template_def = EmailTemplate::AVAILABLE_TEMPLATES[template.name.to_sym] || {} %>
                <% full_description = template_def[:description].present? ? template_def[:description] : template.description.presence || "No description available" %>
                <li class="p-6 sm:p-4 bg-white">
                  <div class="flex flex-col space-y-2">
                    <div class="flex items-center justify-between">
                      <h3 class="text-sm font-semibold text-gray-900">
                        <%= truncate(full_description, length: 50) %>
                      </h3>
                      <span class="text-xs text-gray-600"><%= template.format.titleize %></span>
                    </div>

                    <p class="text-sm text-gray-700">
                      <span class="font-semibold">Subject:</span>
                      <%= template.subject.present? ? truncate(template.subject, length: 50) : "No subject" %>
                    </p>

                    <p class="text-xs font-mono text-gray-600">
                      <span class="font-semibold text-gray-700">ID:</span>
                      <%= template.name %>
                    </p>

                    <div class="flex justify-between items-center text-xs text-gray-600 mb-2">
                      <span>v<%= template.version %> Â· Updated <%= time_ago_in_words(template.updated_at) %> ago</span>
                      <% if template.enabled %>
                        <span class="inline-flex items-center rounded-full bg-green-100 px-2 py-1 text-xs font-medium text-green-800">
                          Enabled
                        </span>
                      <% else %>
                        <span class="inline-flex items-center rounded-full bg-red-100 px-2 py-1 text-xs font-medium text-red-800">
                          Disabled
                        </span>
                      <% end %>
                    </div>
                    <div class="flex justify-between items-center gap-2">
                      <div class="space-x-2">
                        <%= link_to 'View', admin_email_template_path(template), class: "text-indigo-600 hover:text-indigo-900 focus-visible:outline focus-visible:outline-2 focus-visible:outline-indigo-600 text-sm", aria: { label: "View #{template.name} template" } %>
                        <%= link_to 'Edit', edit_admin_email_template_path(template), class: "text-indigo-600 hover:text-indigo-900 focus-visible:outline focus-visible:outline-2 focus-visible:outline-indigo-600 text-sm", aria: { label: "Edit #{template.name} template" } %>
                      </div>
                      <div>
                        <% if template.enabled %>
                          <%= button_to 'Disable', toggle_disabled_admin_email_template_path(template), method: :patch, class: "text-red-600 hover:text-red-900 focus-visible:outline focus-visible:outline-2 focus-visible:outline-red-600 text-sm inline", aria: { label: "Disable #{template.name} template" } %>
                        <% else %>
                          <%= button_to 'Enable', toggle_disabled_admin_email_template_path(template), method: :patch, class: "text-green-600 hover:text-green-900 focus-visible:outline focus-visible:outline-2 focus-visible:outline-green-600 text-sm inline", aria: { label: "Enable #{template.name} template" } %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </li>
              <% end %>
            </ul>
          </div>
        <% else %>
          <div class="p-6 text-center">
            <p class="text-gray-600">No email templates found in the database.</p>
            <p class="mt-2 text-sm text-gray-600">Run `rake db:seed_manual_email_templates` to populate them.</p>
          </div>
        <% end %>
      </div>

      <%# Pagination %>
      <% if @pagy && @pagy.pages > 1 %>
        <div class="px-4 py-3 border-t bg-gray-50" aria-live="polite">
          <%== pagy_nav(@pagy) %>
        </div>
      <% end %>
    </section>
  </div>
</main>
