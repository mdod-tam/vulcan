<main class="container mx-auto px-4 py-8" role="main" aria-labelledby="manage-users-title">
  <div class="max-w-7xl mx-auto">
    <%# Header Section %>
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-gray-900" id="manage-users-title">Manage Users</h1>
      <div>
        <a href="<%= admin_applications_path %>" 
           class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
           data-turbo-frame="_top"
           aria-label="Return to applications dashboard">
          Back to Dashboard
        </a>
      </div>
    </div>
    
    <%# Compact Stats Bar - counts at a glance, filtering via dropdowns below %>
    <section aria-labelledby="user-stats-heading" class="mb-4">
      <h2 id="user-stats-heading" class="sr-only">User Statistics</h2>
      <div class="bg-white rounded-lg shadow px-4 py-3">
        <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm">
          <%# Total %>
          <div class="font-medium text-gray-900">
            <span class="text-lg font-bold text-indigo-600"><%= @total_users_count || 0 %></span>
            <span class="ml-1">users</span>
          </div>
          
          <div class="hidden sm:block text-gray-300">|</div>
          
          <%# Role breakdown - compact inline %>
          <div class="flex flex-wrap gap-x-4 gap-y-1 text-gray-600">
            <% role_counts = { 
                 'Users::Administrator' => { label: 'Admins', short: 'A' },
                 'Users::Evaluator' => { label: 'Evaluators', short: 'E' },
                 'Users::Constituent' => { label: 'Constituents', short: 'C' },
                 'Users::Vendor' => { label: 'Vendors', short: 'V' },
                 'Users::Trainer' => { label: 'Trainers', short: 'T' }
               } %>
            <% role_counts.each do |role_type, display| %>
              <span title="<%= display[:label] %>">
                <span class="font-medium"><%= @user_counts_by_role&.dig(role_type) || 0 %></span>
                <span class="text-gray-400 text-xs"><%= display[:label] %></span>
              </span>
            <% end %>
          </div>
          
          <div class="hidden sm:block text-gray-300">|</div>
          
          <%# Relationships %>
          <div class="flex gap-x-4 text-gray-600">
            <span>
              <span class="font-medium"><%= @guardian_count || 0 %></span>
              <span class="text-gray-400 text-xs">guardians</span>
            </span>
            <span>
              <span class="font-medium"><%= @dependent_count || 0 %></span>
              <span class="text-gray-400 text-xs">dependents</span>
            </span>
          </div>
          
          <%# Needs Review - highlight if > 0 %>
          <% if @needs_review_count.to_i > 0 %>
            <div class="hidden sm:block text-gray-300">|</div>
            <%= link_to admin_users_path(needs_review: 'true'), 
                class: "inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 hover:bg-yellow-200",
                data: { turbo_frame: "users_list" } do %>
              <span class="font-bold mr-1"><%= @needs_review_count %></span> need review
            <% end %>
          <% end %>
        </div>
      </div>
    </section>

    <%# Users List Section %>
    <section aria-labelledby="users-list-heading" class="bg-white rounded-lg shadow">
      <h2 id="users-list-heading" class="sr-only">Users List</h2>
      
      <%# Filters Section %>
      <div class="p-4 border-b border-gray-200">
        <%= form_tag admin_users_path, method: :get, class: "flex flex-wrap items-end gap-4", data: { turbo_frame: "users_list", controller: "autosubmit" } do %>
          <%# Search %>
          <div class="flex-1 min-w-[200px]">
            <%= label_tag :q, "Search", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <div class="relative rounded-md shadow-sm">
              <%= text_field_tag :q, params[:q], 
                  placeholder: "Name or email...",
                  data: { action: "input->autosubmit#search" }, 
                  class: "block w-full pl-9 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
              <div class="absolute inset-y-0 left-0 pl-2.5 flex items-center pointer-events-none">
                <svg class="h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
              </div>
            </div>
          </div>
          
          <%# Role Filter %>
          <div class="w-48">
            <%= label_tag :role, "Role", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= select_tag :role, options_for_select([
              ["All Roles", ""],
              ["Administrator", "administrator"],
              ["Evaluator", "evaluator"],
              ["Constituent", "constituent"],
              ["Vendor", "vendor"],
              ["Trainer", "trainer"]
            ], params[:role]), 
            class: "block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md",
            onchange: "this.form.requestSubmit()" %>
          </div>
          
          <%# Relationship Filter %>
          <div class="w-48">
            <%= label_tag :relationship, "Relationship", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= select_tag :relationship, options_for_select([
              ["All Users", ""],
              ["Guardians Only", "guardian"],
              ["Dependents Only", "dependent"]
            ], params[:relationship]), 
            class: "block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md",
            onchange: "this.form.requestSubmit()" %>
          </div>
          
          <%# Needs Review Checkbox %>
          <div class="flex items-center">
            <%= check_box_tag :needs_review, "true", params[:needs_review].present?, 
                class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded",
                onchange: "this.form.requestSubmit()" %>
            <%= label_tag :needs_review, "Needs Review", class: "ml-2 text-sm font-medium text-gray-700" %>
          </div>
          
          <%# Action Buttons %>
          <div class="flex gap-2">
            <%= submit_tag "Search", class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 cursor-pointer" %>
            
            <% if params[:q].present? || params[:role].present? || params[:needs_review].present? || params[:relationship].present? %>
              <%= link_to "Clear Filters", admin_users_path, 
                  class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                  data: { turbo_frame: "users_list" } %>
            <% end %>
          </div>
        <% end %>
      </div>

      <%# Active Filters Display %>
      <% active_filters = [] %>
      <% active_filters << "Search: \"#{params[:q]}\"" if params[:q].present? %>
      <% active_filters << "Role: #{params[:role].titleize}" if params[:role].present? %>
      <% active_filters << "Relationship: #{params[:relationship].titleize}" if params[:relationship].present? %>
      <% active_filters << "Needs Review" if params[:needs_review].present? %>
      
      <% if active_filters.any? %>
        <div class="px-4 py-2 bg-indigo-50 border-b border-indigo-100">
          <div class="flex items-center">
            <span class="text-sm text-indigo-700 font-medium mr-2">Active filters:</span>
            <div class="flex flex-wrap gap-2">
              <% active_filters.each do |filter| %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                  <%= filter %>
                </span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <%# Users Table (Turbo Frame) %>
      <%= turbo_frame_tag "users_list" do %>
        <%= render partial: 'users_table', locals: { users: @users, pagy: @pagy } %>
      <% end %>
    </section>
  </div>

  <%# Global Feedback Message %>
  <div id="global-feedback" 
       class="fixed bottom-4 right-4 max-w-sm w-full bg-white rounded-lg shadow-lg p-4 hidden"
       role="alert"
       aria-live="polite">
  </div>
</main>
