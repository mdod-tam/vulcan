<%# Users table partial %>
<%# Local variables: users, pagy %>

<% if users.present? %>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200" role="grid">
      <caption class="sr-only">List of system users with roles and capabilities</caption>
      
      <thead class="bg-gray-50">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            User Details
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Relationships
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Email
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Manage Roles & Capabilities
          </th>
        </tr>
      </thead>

      <tbody class="bg-white divide-y divide-gray-200">
        <% users.each do |user| %>
          <%
            is_guardian = user.guardian?
            is_dependent = user.dependent?
          %>
          <tr class="<%= user_row_classes(user) %>">
            <td class="px-6 py-4">
              <div class="space-y-1">
                <div class="text-sm font-medium text-gray-900">
                  <% if is_guardian %>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block text-blue-600 mr-1 align-text-bottom" aria-label="Guardian Icon">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
                    </svg>
                  <% end %>
                  <% if is_dependent %>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block text-green-600 mr-1 align-text-bottom" aria-label="Dependent Icon">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                    </svg>
                  <% end %>
                  <%= link_to user.full_name, admin_user_path(user), class: "hover:text-indigo-600", data: { turbo_frame: "_top" } %>
                  <% if is_guardian && user.dependents_count > 0 %>
                    <span class="ml-1 text-xs text-gray-500">(<%= pluralize(user.dependents_count, "dependent") %>)</span>
                  <% end %>
                  <% if user.needs_duplicate_review %>
                    <span class="ml-2 text-xs font-semibold text-yellow-800 bg-yellow-200 px-2 py-0.5 rounded-full">Needs Review</span>
                  <% end %>
                </div>
                <div class="text-sm text-gray-600 flex flex-wrap gap-2">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    <%= user.role_type %>
                  </span>
                  <% user.available_capabilities.each do |capability| %>
                    <% if user.has_capability?(capability) || user.inherent_capabilities.include?(capability) %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                        <%= capability.titleize %>
                      </span>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </td>

            <td class="px-6 py-4 text-sm text-gray-900">
              <% if is_guardian && !is_dependent && user.dependents.any? %>
                <ul class="list-disc list-inside">
                  <% user.guardian_relationships_as_guardian.each do |gr| %>
                    <% relation = gr.relationship_type %>
                    <li>
                      <%= link_to gr.dependent_user.full_name, admin_user_path(gr.dependent_user), class: "hover:text-indigo-600", data: { turbo_frame: "_top" } %>
                      <span class="text-xs text-gray-500">(<%= inverse_relationship_label(relation) %>)</span>
                    </li>
                  <% end %>
                </ul>
              <% elsif is_dependent && user.guardians.any? %>
                <ul class="list-disc list-inside">
                  <% user.guardian_relationships_as_dependent.each do |gr| %>
                    <% relation = gr.relationship_type.to_s.downcase %>
                    <% label = relation.presence || 'guardian' %>
                    <li>
                      <%= link_to gr.guardian_user.full_name, admin_user_path(gr.guardian_user), class: "hover:text-indigo-600", data: { turbo_frame: "_top" } %>
                      <span class="text-xs text-gray-500">(<%= label %>)</span>
                    </li>
                  <% end %>
                </ul>
              <% else %>
                &nbsp;
              <% end %>
            </td>

            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500 truncate max-w-xs">
                <%= mail_to user.effective_email, class: "hover:text-indigo-600 block", title: user.effective_email %>
              </div>
            </td>

            <td class="px-6 py-4">
              <% if user == current_user %>
                <div class="text-sm text-gray-500 italic">
                  Cannot modify own role
                </div>
              <% else %>
                <div class="space-y-4" 
                     data-controller="role-select"
                     data-role-select-user-id-value="<%= user.id %>"
                     data-role-select-update-role-url-value="<%= update_role_admin_user_path(user) %>"
                     data-role-select-update-capabilities-url-value="<%= update_capabilities_admin_user_path(user) %>">
                  <!-- Primary Role Section -->
                  <div class="role-section">
                    <label for="role_<%= user.id %>" 
                           class="block text-sm font-medium text-gray-700 mb-1">
                      Primary Role
                    </label>
                    <%= select_tag "role_#{user.id}",
                        options_for_select(
                          %w[Users::Administrator Users::Evaluator Users::Constituent Users::Vendor Users::Trainer],
                          selected: user.type
                        ),
                        data: { 
                          role_select_target: "select",
                          action: "change->role-select#roleChanged"
                        },
                        class: "block w-full pl-3 pr-10 py-2 text-base text-gray-900 bg-gray-100 border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md cursor-pointer" %>
                  </div>
                  
                  <!-- Capabilities Section -->
                  <div class="capabilities-section">
                    <p class="text-sm font-medium text-gray-700 mb-2">
                      Capabilities
                    </p>
                    
                    <div class="space-y-2">
                      <% user.available_capabilities.each do |capability| %>
                        <div class="relative flex items-start">
                          <div class="flex items-center h-5">
                            <%= check_box_tag "capability_#{capability}_#{user.id}",
                                "1",
                                user.has_capability?(capability) || user.inherent_capabilities.include?(capability),
                                data: {
                                  role_select_target: "capability",
                                  action: "click->role-select#toggleCapability",
                                  capability: capability
                                },
                                disabled: user.inherent_capabilities.include?(capability),
                                id: "capability_#{capability}_#{user.id}",
                                class: "h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer #{user.inherent_capabilities.include?(capability) ? 'opacity-50' : ''}" %>
                          </div>
                          <div class="ml-3 text-sm">
                            <label for="capability_<%= capability %>_<%= user.id %>" 
                                  class="font-medium text-gray-700 cursor-pointer">
                              <%= capability.titleize %>
                              <% if user.inherent_capabilities.include?(capability) %>
                                <span class="text-sm text-gray-500 italic ml-1">(from role)</span>
                              <% end %>
                            </label>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  </div>

                  <div data-role-select-target="feedback" 
                       class="hidden mt-2 text-sm rounded-md"></div>
                </div>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <%# Pagination %>
  <% if defined?(pagy) && pagy.pages > 1 %>
    <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
      <div class="flex-1 flex justify-between sm:hidden">
        <% if pagy.prev %>
          <%= link_to 'Previous', admin_users_path(request.params.merge(page: pagy.prev)), 
              class: "relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",
              data: { turbo_frame: "users_list" } %>
        <% end %>
        <% if pagy.next %>
          <%= link_to 'Next', admin_users_path(request.params.merge(page: pagy.next)), 
              class: "ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",
              data: { turbo_frame: "users_list" } %>
        <% end %>
      </div>
      <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
        <div>
          <p class="text-sm text-gray-700">
            Showing
            <span class="font-medium"><%= pagy.from %></span>
            to
            <span class="font-medium"><%= pagy.to %></span>
            of
            <span class="font-medium"><%= pagy.count %></span>
            users
          </p>
        </div>
        <div>
          <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
            <% if pagy.prev %>
              <%= link_to admin_users_path(request.params.merge(page: pagy.prev)), 
                  class: "relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50",
                  data: { turbo_frame: "users_list" } do %>
                <span class="sr-only">Previous</span>
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                </svg>
              <% end %>
            <% end %>
            
            <% pagy.series.each do |item| %>
              <% if item == :gap %>
                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>
              <% elsif item.is_a?(Integer) %>
                <% if item == pagy.page %>
                  <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-indigo-50 text-sm font-medium text-indigo-600" aria-current="page"><%= item %></span>
                <% else %>
                  <%= link_to item, admin_users_path(request.params.merge(page: item)), 
                      class: "relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50",
                      data: { turbo_frame: "users_list" } %>
                <% end %>
              <% end %>
            <% end %>
            
            <% if pagy.next %>
              <%= link_to admin_users_path(request.params.merge(page: pagy.next)), 
                  class: "relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50",
                  data: { turbo_frame: "users_list" } do %>
                <span class="sr-only">Next</span>
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                </svg>
              <% end %>
            <% end %>
          </nav>
        </div>
      </div>
    </div>
  <% end %>
<% else %>
  <div class="text-center py-12">
    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
    </svg>
    <h3 class="mt-2 text-sm font-medium text-gray-900">No users found</h3>
    <p class="mt-1 text-sm text-gray-500">
      <% if params[:q].present? || params[:role].present? || params[:needs_review].present? || params[:relationship].present? %>
        Try adjusting your search or filter criteria.
      <% else %>
        No users have been created yet.
      <% end %>
    </p>
  </div>
<% end %>

