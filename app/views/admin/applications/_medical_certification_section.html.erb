<%# Medical Certification Section Content
     This partial is rendered inside #medical-certification-section and can be
     updated via Turbo Stream for a smooth UX without full page reload.
%>
<div class="flex justify-between items-start">
  <h2 id="certification-title" class="text-xl font-semibold text-gray-900">Medical Certification</h2>
  <div class="flex items-center space-x-2">
    <%= medical_certification_status_badge(@application) %>
    <%= document_signing_status_badge(@application) %>
  </div>
</div>

<div class="mt-6 space-y-4">
  <!-- Fax Upload Form and History -->
  <%= render "medical_certification_upload" %>

  <!-- Provider Information -->
  <% if @application.medical_provider_name.present? %>
    <div class="mb-4" data-testid="provider-information">
      <h3 class="text-sm font-medium text-gray-700 mb-2">Provider Information</h3>
      <div class="pl-4 border-l-2 border-gray-200">
        <p class="text-sm font-medium text-gray-900"><%= @application.medical_provider_name %></p>
        <p class="text-sm text-gray-600">
          <% if @application.medical_provider_phone.present? %>
            Phone: <%= @application.medical_provider_phone %>
          <% end %>
          <% if @application.respond_to?(:medical_provider_fax) && @application.medical_provider_fax.present? %>
            <% if @application.medical_provider_phone.present? %> / <% end %>
            Fax: <%= @application.medical_provider_fax %>
          <% end %>
          <% if @application.medical_provider_email.present? %>
            <br>Email: <%= @application.medical_provider_email %>
          <% end %>
        </p>
      </div>
    </div>
  <% end %>

  <!-- Action Buttons -->
  <div class="mt-6">
    <%
      # Load request counts for button copy
      request_count = @application.medical_certification_request_count || 0
      docuseal_count = @application.document_signing_request_count || 0

      if !defined?(@latest_certification_request) || @latest_certification_request.nil?
        @latest_certification_request = Notification
          .where(notifiable: @application, action: "medical_certification_requested")
          .order(created_at: :desc)
          .limit(1)
          .first
      end

      if !defined?(@latest_certification_reject) || @latest_certification_reject.nil?
        @latest_certification_reject = Notification
          .where(notifiable: @application, action: "medical_certification_rejected")
          .order(created_at: :desc)
          .limit(1)
          .first
      end

      # Check if we have both a request and a rejection, and if the request is more recent than the rejection
      requested_after_rejection = @latest_certification_request.present? &&
                                 @latest_certification_reject.present? &&
                                 @latest_certification_request.created_at > @latest_certification_reject.created_at

      # Check if provider info is complete for DocuSeal
      provider_info_complete = @application.medical_provider_name.present? && @application.medical_provider_email.present?
      
      # Determine DocuSeal button text and state
      docuseal_text = docuseal_button_text(@application)
    %>

    <% if show_medical_certification_request_buttons?(@application) && !@application.document_signing_status_signed? %>
      <div class="flex flex-wrap gap-2">
        <!-- DocuSeal Button (Default) -->
        <% if provider_info_complete %>
          <%= button_to send_document_signing_request_admin_application_path(@application),
              method: :post,
              class: "inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
              data: {
                disable_with: "Sending...",
                turbo_confirm: "Send digital signing request to #{@application.medical_provider_name} (#{@application.medical_provider_email}) for #{@application.constituent_full_name}'s medical certification?"
              },
              'aria-label': "Send DocuSeal digital signing request to #{@application.medical_provider_name}" do %>
            <%= docuseal_text %>
          <% end %>
        <% else %>
          <button disabled 
                  aria-disabled="true"
                  title="Provider name and email required for DocuSeal"
                  class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-400 bg-gray-100 cursor-not-allowed">
            <%= docuseal_text %>
          </button>
        <% end %>

        <!-- Email Button (Alternative) -->
        <% email_button_text = request_count.zero? ? "Send Email" : "Resend Email" %>
        <%= button_to resend_medical_certification_admin_application_path(@application),
            method: :post,
            class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
            data: {
              disable_with: "Sending...",
              turbo_confirm: "Send email request to #{@application.medical_provider_name} for #{@application.constituent_full_name}'s disability certification form?"
            },
            'aria-label': "Send email request to #{@application.medical_provider_name}" do %>
          <%= email_button_text %>
        <% end %>

        <!-- Print Button (Alternative) -->
        <%= button_to queue_medical_certification_form_admin_application_path(@application),
            method: :post,
            class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
            data: {
              disable_with: "Queuing...",
              turbo_confirm: "Add Disability Certification Form to the print queue?"
            },
            'aria-label': "Queue disability certification form for printing" do %>
          Print DCF
        <% end %>
      </div>

    <% elsif (@application.medical_certification_status == "received" ||
           (@application.medical_certification_status == "requested" && @application.medical_certification.attached?) ||
           requested_after_rejection) &&
           !["approved"].include?(@application.medical_certification_status) %>
      <!-- Review button - Show this only when we have a certification to review AND it's not already accepted/approved -->
      <button type="button"
            data-action="click->modal#open"
            data-modal-id="medicalCertificationReviewModal"
            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">
        Review Certification
      </button>
    <% end %>
  </div>
</div>

