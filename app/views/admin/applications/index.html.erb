<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<main class="container mx-auto px-4 py-8" role="main" id="main-content">
  <div class="max-w-7xl mx-auto">
    <%# Skip to content link for keyboard users %>
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:p-4 focus:bg-white focus:z-50">
      Skip to main content
    </a>
    
    <%# Admin Header Section - Contains page title and primary action buttons %>
    <div class="mb-6">
      <h1 class="text-3xl font-bold mb-4" id="page-title">
        Admin Dashboard
      </h1>
      
      <%# 
        Administrative Action Buttons
        - These buttons provide access to key administrative functions
        - Now organized in a responsive grid layout for better space usage on desktop
        - Maintains vertical stacking on mobile for touch-friendly access
        - All buttons use consistent sizing and accessibility attributes
      %>
      <div class="mb-4">
        <!-- Container grid for responsive layout -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- System Configuration Group - col 1 on desktop -->
          <div>
            <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-2">System Configuration</h3>
            <div class="flex flex-wrap gap-4">
              <%= link_to admin_policies_path,
                  class: "inline-flex items-center px-4 py-2 min-h-[44px] border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                  aria: { label: "Edit system policies and settings" } do %>
                <span>Edit Policies</span>
              <% end %>
              
              <%= link_to admin_users_path,
                  class: "inline-flex items-center px-4 py-2 min-h-[44px] border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                  aria: { label: "Manage system users" } do %>
                <span>Edit Users</span>
              <% end %>
              
              <%= link_to admin_products_path,
                  class: "inline-flex items-center px-4 py-2 min-h-[44px] border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                  aria: { label: "Manage products catalog" } do %>
                <span>Manage Products</span>
              <% end %>
            </div>
          </div>
          
          <!-- Resource Management Group - col 2 on desktop -->
          <div>
            <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-2">Resource Management</h3>
            <div class="flex flex-wrap gap-4">
              <%= link_to admin_vendors_path,
                  class: "inline-flex items-center px-4 py-2 min-h-[44px] border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                  aria: { label: "Manage system vendors" } do %>
                <span>Manage Vendors</span>
              <% end %>
              
              <%= link_to admin_vouchers_path,
                  class: "inline-flex items-center px-4 py-2 min-h-[44px] border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                  aria: { label: "Manage system vouchers" },
                  data: { turbo: false } do %>
                <span>Manage Vouchers</span>
              <% end %>
              
              <%= link_to admin_invoices_path,
                  class: "inline-flex items-center px-4 py-2 min-h-[44px] border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                  aria: { label: "Manage system invoices" } do %>
                <span>Manage Invoices</span>
              <% end %>
            </div>
          </div>
          
          <!-- Operations Group - spans full width on desktop -->
          <div class="md:col-span-2">
            <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-2">Operations</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-2">
              <%= link_to new_admin_paper_application_path,
                  class: "inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                  aria: { label: "Upload a paper application" } do %>
                <span>Upload Paper Application</span>
              <% end %>
              
              <%= link_to trainers_training_sessions_path,
                  class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                  aria: { label: "View training sessions" } do %>
                <span>View Trainings</span>
              <% end %>
              
              <%= link_to evaluators_evaluations_path,
                  class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                  aria: { label: "View evaluations" } do %>
                <span>View Evaluations</span>
              <% end %>
              
              <%= link_to admin_reports_path,
                  class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                  aria: { label: "View detailed system reports" } do %>
                <span>View Reports</span>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%# Status Cards Section %>
    <section aria-labelledby="status-cards-heading" class="mb-6">
      <h2 id="status-cards-heading" class="sr-only">Application Status Overview</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow p-6">
          <h3 id="active-applications-heading" class="text-lg font-medium text-gray-900">Active Applications</h3>
          <p class="text-3xl font-bold text-indigo-600" aria-labelledby="active-applications-heading" aria-live="polite"><%= @open_applications_count || 0 %></p>
          <p class="text-sm text-gray-500">All active applications: submitted but unapproved</p>
          <div class="mt-2">
            <%= link_to params[:filter] == 'active' ? admin_applications_path : admin_applications_path(filter: 'active'),
                class: "inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                aria: { label: params[:filter] == 'active' ? "View all applications" : "View only active applications" } do %>
              <span><%= params[:filter] == 'active' ? 'View All Applications' : 'View Only Active Applications' %></span>
              <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            <% end %>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
          <h3 id="approved-heading" class="text-lg font-medium text-gray-900">Approved</h3>
          <p class="text-3xl font-bold text-indigo-600" aria-labelledby="approved-heading" aria-live="polite"><%= @pending_services_count || 0 %></p>
          <p class="text-sm text-gray-500">Approved and awaiting services</p>
          <div class="mt-2">
            <%= link_to params[:filter] == 'approved' ? admin_applications_path : admin_applications_path(filter: 'approved'),
                class: "inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                aria: { label: params[:filter] == 'approved' ? "View all applications" : "View only approved applications" } do %>
              <span><%= params[:filter] == 'approved' ? 'View All Applications' : 'View Only Approved' %></span>
              <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            <% end %>
          </div>
        </div>
      </div>
    </section>
    
    <%# Common Tasks Section %>
    <section aria-labelledby="common-tasks-heading" class="bg-white rounded-lg shadow p-4 mb-6">
      <h2 id="common-tasks-heading" class="text-lg font-medium text-gray-900 mb-4">Common Tasks</h2>
      <div class="flex flex-wrap gap-4">
        <%= link_to admin_applications_path(filter: 'proofs_needing_review'),
            class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 #{params[:filter] == 'proofs_needing_review' ? 'bg-gray-50' : ''}",
            aria: { label: "View applications with proofs needing review" } do %>
          <span>Proofs Needing Review (<%= @proofs_needing_review_count %>)</span>
        <% end %>
        
        <%= link_to admin_applications_path(filter: 'medical_certs_to_review'),
            class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 #{params[:filter] == 'medical_certs_to_review' ? 'bg-gray-50' : ''}",
            aria: { label: "View applications with medical certifications to review" } do %>
          <span>Medical Certs to Review (<%= @medical_certs_to_review_count %>)</span>
        <% end %>
        
        <%= link_to admin_applications_path(filter: 'training_requests'),
            class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 #{params[:filter] == 'training_requests' ? 'bg-gray-50' : ''}",
            aria: { label: "View applications with training requests" } do %>
          <span>Training Requests (<%= @training_requests_count %>)</span>
        <% end %>
      </div>
    </section>

    <%# Applications Section with Integrated Filters %>
    <section aria-labelledby="applications-heading" class="bg-white rounded-lg shadow mb-6">
      <h2 id="applications-heading" class="sr-only">Applications</h2>
      <div class="p-4 border-b">
        <h3 class="text-lg font-medium text-gray-900">Applications</h3>
      </div>
      
      <div class="p-4 border-b">
        <%= form_tag admin_applications_path, method: :get, class: "flex flex-wrap items-center gap-4" do %>
          <div class="flex items-center gap-2">
            <%= label_tag :status, "Status:", class: "text-sm font-medium text-gray-700" %>
            <%= select_tag :status, options_for_select([
              ["All", ""],
              ["Draft", "draft"],
              ["Submitted", "submitted"],
              ["In Review", "in_review"],
              ["Approved", "approved"],
              ["Rejected", "rejected"]
            ], params[:status]), class: "rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %>
          </div>
          
          <div class="flex items-center gap-2">
            <%= label_tag :date_range, "Date Range:", class: "text-sm font-medium text-gray-700" %>
            <%= select_tag :date_range, options_for_select([
              ["All Time", ""],
              ["Current FY", "current_fy"],
              ["Previous FY", "previous_fy"],
              ["Last 30 Days", "last_30"],
              ["Last 90 Days", "last_90"]
            ], params[:date_range]), class: "rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %>
          </div>
          
          <div class="flex items-center gap-2">
            <%= label_tag :q, "Search:", class: "sr-only" %>
            <div class="relative rounded-md shadow-sm">
              <%= text_field_tag :q, params[:q], placeholder: "Search applications...", class: "focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-3 pr-10 py-2 sm:text-sm border-gray-300 rounded-md" %>
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
              </div>
            </div>
          </div>

          <%= submit_tag "Apply Filters", class: "inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
          <%= link_to "Clear Filters", admin_applications_path, class: "ml-2 inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
        <% end %>
      </div>

      <div class="overflow-x-auto">
        <% if @applications.present? %>
          <%= render partial: 'applications_table', locals: { applications: @applications } %>
        <% else %>
          <div class="p-6 text-center">
            <p class="text-gray-500">No applications found</p>
          </div>
        <% end %>
      </div>

      <%# Pagination %>
      <% if @pagy && @pagy.pages > 1 %>
        <div class="px-4 py-3 border-t">
          <%== pagy_nav(@pagy) %>
        </div>
      <% end %>
    </section>

    <%# Notifications Section - Moved below applications table %>
    <section aria-labelledby="notifications-heading" class="bg-white rounded-lg shadow p-4 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 id="notifications-heading" class="text-lg font-medium text-gray-900">Recent Notifications</h2>
        <%= link_to notifications_path, 
            class: "text-sm font-medium text-indigo-600 hover:text-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 flex items-center",
            aria: { label: "View all notifications" } do %>
          View All
          <svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        <% end %>
      </div>
      
      <% if @recent_notifications.present? %>
        <ul class="divide-y divide-gray-200">
          <% @recent_notifications.each do |notification| %>
            <li class="py-3 flex items-start">
              <div class="flex-shrink-0 mr-3">
                <!-- Notification icon based on type -->
                <span class="inline-flex items-center justify-center h-8 w-8 rounded-full <%= notification.action == 'trainer_assigned' ? 'bg-green-100 text-green-500' : 'bg-indigo-100 text-indigo-500' %>">
                  <% if notification.action == 'trainer_assigned' %>
                    <!-- Training icon -->
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                  <% else %>
                    <!-- Default info icon -->
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  <% end %>
                </span>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-900"><%= notification.message %></p>
                <p class="text-xs text-gray-500"><%= time_ago_in_words(notification.created_at) %> ago</p>
              </div>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="text-sm text-gray-500">No recent notifications</p>
      <% end %>
    </section>

    <%# Charts Section - Moved below applications section %>
    <section aria-labelledby="charts-heading" class="mb-6">
      <h2 id="charts-heading" class="sr-only">Application Charts</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow p-6">
          <h3 id="pipeline-heading" class="text-lg font-medium text-gray-900 mb-4">FY<%= @current_fiscal_year.to_s[-2..-1] %> Application Pipeline</h3>
          <div class="h-64" 
               data-controller="reports-chart" 
               data-reports-chart-current-data-value="<%= @pipeline_chart_data.to_json %>"
               data-reports-chart-previous-data-value="<%= {}.to_json %>"
               data-reports-chart-type-value="bar"
               data-reports-chart-title-value="Application Pipeline">
            <div class="sr-only" aria-labelledby="pipeline-heading">
              Chart showing application pipeline: <%= @submitted_count %> submitted, <%= @in_review_count %> in review, and <%= @approved_count %> approved applications.
            </div>
          </div>
          <div class="mt-4 grid grid-cols-4 gap-4 text-center">
            <div>
              <p class="text-sm font-medium text-gray-500">Draft</p>
              <p class="text-xs text-gray-500">Started, Not Submitted</p>
              <p class="text-lg font-bold"><%= @draft_count %></p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">Submitted</p>
              <p class="text-lg font-bold"><%= @submitted_count %></p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">In Review</p>
              <p class="text-lg font-bold"><%= @in_review_count %></p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">Approved</p>
              <p class="text-lg font-bold"><%= @approved_count %></p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <h3 id="status-breakdown-heading" class="text-lg font-medium text-gray-900 mb-2">Status Breakdown</h3>
          <p class="text-sm text-gray-500 mb-4">Current FY Application Breakdown</p>
          <div class="h-64" 
               data-controller="reports-chart" 
               data-reports-chart-current-data-value="<%= @status_chart_data.to_json %>"
               data-reports-chart-previous-data-value="<%= {}.to_json %>"
               data-reports-chart-type-value="polarArea"
               data-reports-chart-title-value="Status Breakdown">
            <div class="sr-only" aria-labelledby="status-breakdown-heading">
              Chart showing status breakdown: <%= @draft_count %> draft, <%= @in_progress_count %> in progress, <%= @approved_count %> approved, and <%= @rejected_count %> rejected applications.
            </div>
          </div>
          <div class="mt-4 grid grid-cols-2 gap-4">
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-500">Draft:</span>
              <span class="text-sm font-bold"><%= @draft_count %> (<%= number_to_percentage((@draft_count.to_f / (@draft_count + @in_progress_count + @approved_count + @rejected_count)) * 100, precision: 1) unless (@draft_count + @in_progress_count + @approved_count + @rejected_count).zero? %>)</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-500">In Progress:</span>
              <span class="text-sm font-bold"><%= @in_progress_count %> (<%= number_to_percentage((@in_progress_count.to_f / (@draft_count + @in_progress_count + @approved_count + @rejected_count)) * 100, precision: 1) unless (@draft_count + @in_progress_count + @approved_count + @rejected_count).zero? %>)</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-500">Approved:</span>
              <span class="text-sm font-bold"><%= @approved_count %> (<%= number_to_percentage((@approved_count.to_f / (@draft_count + @in_progress_count + @approved_count + @rejected_count)) * 100, precision: 1) unless (@draft_count + @in_progress_count + @approved_count + @rejected_count).zero? %>)</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-500">Rejected:</span>
              <span class="text-sm font-bold"><%= @rejected_count %> (<%= number_to_percentage((@rejected_count.to_f / (@draft_count + @in_progress_count + @approved_count + @rejected_count)) * 100, precision: 1) unless (@draft_count + @in_progress_count + @approved_count + @rejected_count).zero? %>)</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>
