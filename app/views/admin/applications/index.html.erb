<main class="container mx-auto px-4 py-8" role="main" id="main-content">
  <div class="max-w-7xl mx-auto">
    <%# Skip to content link for keyboard users %>
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:p-4 focus:bg-white focus:z-50">
      Skip to main content
    </a>
    
    <%# Admin Header Section - Contains page title and primary action buttons %>
    <div class="mb-6">
      <!-- Hidden semantic landmark for test compatibility -->
      <h1 class="sr-only">Dashboard</h1>
      
      <h1 class="text-3xl font-bold mb-4" id="page-title">
        Admin Dashboard
      </h1>
      
      <%# 
        Administrative Action Buttons
        - These buttons provide access to key administrative functions
        - Now organized in a responsive grid layout for better space usage on desktop
        - Maintains vertical stacking on mobile for touch-friendly access
        - All buttons use consistent sizing and accessibility attributes
        - Reorganized into task-oriented groups for better workflow
        - Uses a responsive grid to reduce vertical space
      %>
      <div class="mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6"> 
          
          <!-- Row 1, Col 1: Groups 1 & 2 -->
          <div class="space-y-6"> 
            <!-- Group 1: Direct Application Input & Queues -->
            <div>
              <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-2">Direct Application Input & Queues</h3>
              <div class="flex flex-wrap gap-4">
                <%= link_to new_admin_paper_application_path,
                    class: "inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500", # Primary button style
                    aria: { label: "Upload a paper application" } do %>
                  <span>Upload Paper Application</span>
                <% end %>
                
                <%= link_to admin_print_queue_index_path, class: "relative inline-flex items-center px-4 py-2 min-h-[44px] border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" do %>
                  <span class="inline-block pr-2">Print Queue</span>
                  <% pending_count = PrintQueueItem.pending.count rescue 0 %>
                  <% if pending_count > 0 %>
                    <span class="absolute right-2 top-1/2 -translate-y-1/2 flex h-5 w-5 items-center justify-center rounded-full bg-red-600 text-xs text-white">
                      <%= pending_count %>
                    </span>
                  <% end %>
                <% end %>
              </div>
            </div>

            <!-- Group 2: Review & Processing Workflows -->
            <div>
              <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-2">Review & Processing Workflows</h3>
              <div class="flex flex-wrap gap-4">
                <%= link_to trainers_dashboard_path,
                    class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                    aria: { label: "View trainings dashboard" } do %>
                  <span>View Trainings</span>
                <% end %>
                
                <%= link_to evaluators_dashboard_path,
                    class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                    aria: { label: "View evaluations dashboard" } do %>
                  <span>View Evaluations</span>
                <% end %>
                <%# Consider adding links from 'Common Tasks' here if needed %>
              </div>
            </div>
          </div>

          <!-- Row 1, Col 2: Group 3 -->
          <div> 
            <!-- Group 3: Data Management -->
            <div>
              <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-2">Data Management</h3>
              <div class="flex flex-wrap gap-4">
                <%= link_to admin_users_path,
                    class: "inline-flex items-center px-4 py-2 min-h-[44px] border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                    aria: { label: "Manage system users" } do %>
                  <span>Manage Users</span>
                <% end %>
                
                <%= link_to admin_vendors_path,
                    class: "inline-flex items-center px-4 py-2 min-h-[44px] border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                    aria: { label: "Manage system vendors" } do %>
                  <span>Manage Vendors</span>
                <% end %>

                <%= link_to admin_products_path,
                    class: "inline-flex items-center px-4 py-2 min-h-[44px] border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                    aria: { label: "Manage products catalog" } do %>
                  <span>Manage Products</span>
                <% end %>

                <%= link_to admin_vouchers_path,
                    class: "inline-flex items-center px-4 py-2 min-h-[44px] border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                    aria: { label: "Manage system vouchers" },
                    data: { turbo: false } do %>
                  <span>Manage Vouchers</span>
                <% end %>
                
                <%= link_to admin_invoices_path,
                    class: "inline-flex items-center px-4 py-2 min-h-[44px] border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                    aria: { label: "Manage system invoices" } do %>
                  <span>Manage Invoices</span>
                <% end %>
              </div>
            </div>
          </div>

          <!-- Row 2, Col 1: Group 4 -->
          <div>
            <!-- Group 4: System Configuration -->
            <div>
              <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-2">System Configuration</h3>
              <div class="flex flex-wrap gap-4">
                <%= link_to admin_policies_path,
                    class: "inline-flex items-center px-4 py-2 min-h-[44px] border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                  aria: { label: "Edit system policies and settings" } do %>
                  <span>Edit Policies</span>
                <% end %>

                <%= link_to admin_email_templates_path,
                    class: "inline-flex items-center px-4 py-2 min-h-[44px] border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                    aria: { label: "Manage email templates" } do %>
                  <span>Manage Emails</span>
                <% end %>
              </div>
            </div>
          </div>
          
          <!-- Row 2, Col 2: Group 5 -->
          <div>
            <!-- Group 5: Analytics & Reporting -->
            <div>
              <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-2">Analytics & Reporting</h3>
              <div class="flex flex-wrap gap-4">
                <%= link_to admin_reports_path,
                    class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                    aria: { label: "View detailed system reports" } do %>
                  <span>View Reports</span>
                <% end %>

                <%= link_to admin_application_analytics_pain_points_path,
                    class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                    aria: { label: "View application pain point analysis" } do %>
                <span>Pain Point Analysis</span>
              <% end %>
            </div>
          </div>
        </div>
        
      </div>
      </div>

    <%# Status Cards Section %>
    <section aria-labelledby="status-cards-heading" class="mb-6">
      <h2 id="status-cards-heading" class="sr-only">Application Status Overview</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow p-6">
          <h3 id="active-applications-heading" class="text-lg font-medium text-gray-900">In Progress Applications</h3>
          <p class="text-3xl font-bold text-indigo-600" aria-labelledby="active-applications-heading" aria-live="polite"><%= @open_applications_count || 0 %></p>
          <p class="text-sm text-gray-500">All active applications: submitted but unapproved</p>
          <div class="mt-2">
            <%= link_to params[:filter] == 'active' ? admin_applications_path : admin_applications_path(filter: 'active'),
                class: "inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                aria: { label: params[:filter] == 'active' ? "View all applications" : "View only active applications" } do %>
              <span><%= params[:filter] == 'active' ? 'View All Applications' : 'View Only Active Applications' %></span>
              <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            <% end %>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
          <h3 id="approved-heading" class="text-lg font-medium text-gray-900">Approved</h3>
          <p class="text-3xl font-bold text-indigo-600" aria-labelledby="approved-heading" aria-live="polite"><%= @pending_services_count || 0 %></p>
          <p class="text-sm text-gray-500">Approved and awaiting services</p>
          <div class="mt-2">
            <%= link_to params[:filter] == 'approved' ? admin_applications_path : admin_applications_path(filter: 'approved'),
                class: "inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                aria: { label: params[:filter] == 'approved' ? "View all applications" : "View only approved applications" } do %>
              <span><%= params[:filter] == 'approved' ? 'View All Applications' : 'View Only Approved' %></span>
              <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            <% end %>
          </div>
        </div>
      </div>
    </section>
    
    <%# Common Tasks Section %>
    <section aria-labelledby="common-tasks-heading" class="bg-white rounded-lg shadow p-4 mb-6">
      <h2 id="common-tasks-heading" class="text-lg font-medium text-gray-900 mb-4">Common Tasks</h2>
      <div class="flex flex-wrap gap-4">
        <%= link_to admin_applications_path(filter: 'proofs_needing_review'),
            class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 #{params[:filter] == 'proofs_needing_review' ? 'bg-gray-50' : ''}",
            aria: { label: "View applications with proofs needing review" } do %>
          <span>Proofs Needing Review (<%= @proofs_needing_review_count %>)</span>
        <% end %>
        
        <%= link_to admin_applications_path(filter: 'medical_certs_to_review'),
            class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 #{params[:filter] == 'medical_certs_to_review' ? 'bg-gray-50' : ''}",
            aria: { label: "View applications with medical certifications to review" } do %>
          <span>Medical Certs to Review (<%= @medical_certs_to_review_count %>)</span>
        <% end %>
        
        <%= link_to admin_applications_path(filter: 'training_requests'),
            class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 #{params[:filter] == 'training_requests' ? 'bg-gray-50' : ''}",
            aria: { label: "View applications with training requests" } do %>
          <span>Training Requests (<%= @training_requests_count %>)</span>
        <% end %>
      </div>
    </section>

    <%# Applications Section with Integrated Filters %>
    <section aria-labelledby="applications-heading" class="bg-white rounded-lg shadow mb-6">
      <h2 id="applications-heading" class="sr-only">Applications</h2>
      <div class="p-4 border-b">
        <h3 class="text-lg font-medium text-gray-900">Applications</h3>
      </div>
      
      <div class="p-4 border-b">
        <%= form_tag admin_applications_path, method: :get, class: "flex flex-wrap items-center gap-4" do %>
          <div class="flex items-center gap-2">
            <%= label_tag :status, "Status:", class: "text-sm font-medium text-gray-700" %>
            <%= select_tag :status, options_for_select([
              ["All", ""],
              ["Draft", "draft"],
              ["Submitted", "submitted"],
              ["In Review", "in_review"],
              ["Approved", "approved"],
              ["Rejected", "rejected"]
            ], params[:status]), class: "rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %>
          </div>
          
          <div class="flex items-center gap-2">
            <%= label_tag :date_range, "Date Range:", class: "text-sm font-medium text-gray-700" %>
            <%= select_tag :date_range, options_for_select([
              ["All Time", ""],
              ["Current FY", "current_fy"],
              ["Previous FY", "previous_fy"],
              ["Last 30 Days", "last_30"],
              ["Last 90 Days", "last_90"]
            ], params[:date_range]), class: "rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %>
          </div>
          
          <div class="flex items-center gap-2">
            <%= label_tag :q, "Search:", class: "sr-only" %>
            <div class="relative rounded-md shadow-sm">
              <%= text_field_tag :q, params[:q], placeholder: "Search applications...", class: "focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-3 pr-10 py-2 sm:text-sm border-gray-300 rounded-md" %>
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
              </div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <%= label_tag :managing_guardian_q, "Managing Guardian:", class: "text-sm font-medium text-gray-700" %>
            <%= text_field_tag :managing_guardian_q, params[:managing_guardian_q], placeholder: "Search guardian...", class: "rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %>
          </div>

          <div class="flex items-center gap-2">
            <%= label_tag :dependent_q, "Dependent:", class: "text-sm font-medium text-gray-700" %>
            <%= text_field_tag :dependent_q, params[:dependent_q], placeholder: "Search dependent...", class: "rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-ring-indigo-200 focus:ring-opacity-50" %>
          </div>

          <div class="flex items-center gap-2">
            <%= check_box_tag :for_minors, "true", params[:for_minors].present?, class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" %>
            <%= label_tag :for_minors, "Show only dependent applications", class: "text-sm font-medium text-gray-700" %>
          </div>

          <%= submit_tag "Apply Filters", class: "inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
          <%= link_to "Clear Filters", admin_applications_path, class: "ml-2 inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
        <% end %>
      </div>

      <div class="overflow-x-auto">
        <% if @applications.present? %>
          <%= render partial: 'applications_table', locals: { applications: @applications } %>
        <% else %>
          <div class="p-6 text-center">
            <p class="text-gray-500">No applications found</p>
          </div>
        <% end %>
      </div>

      <%# Pagination %>
      <% if @pagy && @pagy.pages > 1 %>
        <div class="px-4 py-3 border-t">
          <%== pagy_nav(@pagy) %>
        </div>
      <% end %>
    </section>

    <%# Notifications Section - Moved below applications table %>
    <section aria-labelledby="notifications-heading" class="bg-white rounded-lg shadow p-4 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 id="notifications-heading" class="text-lg font-medium text-gray-900">Recent Notifications</h2>
        <%= link_to notifications_path(scope: 'all'), 
            class: "text-sm font-medium text-indigo-600 hover:text-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 flex items-center",
            aria: { label: "View all notifications" } do %>
          View All
          <svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        <% end %>
      </div>
      
      <% if @recent_notifications.present? %>
        <ul class="divide-y divide-gray-200">
          <% @recent_notifications.each do |notification| %>
            <!-- Use render instead of inline partial to avoid implicit loading of notifiable association -->
            <%= render "notifications/notification", notification: notification %>
          <% end %>
        </ul>
      <% else %>
        <p class="text-sm text-gray-500">No recent notifications</p>
      <% end %>
    </section>

    <%# Charts Section - Moved below applications section %>
    <section aria-labelledby="charts-heading" class="mb-6">
      <h2 id="charts-heading" class="sr-only">Application Charts</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow p-6">
          <h3 id="pipeline-heading" class="text-lg font-medium text-gray-900 mb-4">FY<%= @current_fiscal_year.to_s[-2..-1] %> Application Pipeline</h3>
          <%= turbo_frame_tag "pipeline_chart_frame" do %>
          <div class="h-64" 
               data-controller="reports-chart" 
               data-reports-chart-current-data-value="<%= @pipeline_chart_data.to_json %>"
               data-reports-chart-previous-data-value="<%= {}.to_json %>"
               data-reports-chart-type-value="bar"
               data-reports-chart-title-value="Application Pipeline"
               data-reports-chart-hidden-class="hidden">
            <div class="sr-only" aria-labelledby="pipeline-heading">
              Chart showing application pipeline: <%= @submitted_count %> submitted, <%= @in_review_count %> in review, and <%= @approved_count %> approved applications.
            </div>
          </div>
          <% end %>
          <div class="mt-4 grid grid-cols-4 gap-4 text-center">
            <div>
              <p class="text-sm font-medium text-gray-500">Draft</p>
              <p class="text-xs text-gray-500">Started, Not Submitted</p>
              <p class="text-lg font-bold"><%= @draft_count %></p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">Submitted</p>
              <p class="text-lg font-bold"><%= @submitted_count %></p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">In Review</p>
              <p class="text-lg font-bold"><%= @in_review_count %></p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">Approved</p>
              <p class="text-lg font-bold"><%= @approved_count %></p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <h3 id="status-breakdown-heading" class="text-lg font-medium text-gray-900 mb-2">Status Breakdown</h3>
          <p class="text-sm text-gray-500 mb-4">Current FY Application Breakdown</p>
          <div class="h-64" 
               data-controller="reports-chart" 
               data-reports-chart-current-data-value="<%= @status_chart_data.to_json %>"
               data-reports-chart-previous-data-value="<%= {}.to_json %>"
               data-reports-chart-type-value="polarArea"
               data-reports-chart-title-value="Status Breakdown"
               data-reports-chart-hidden-class="hidden">
            <div class="sr-only" aria-labelledby="status-breakdown-heading">
              Chart showing status breakdown: <%= @draft_count %> draft, <%= @in_progress_count %> in progress, <%= @approved_count %> approved, and <%= @rejected_count %> rejected applications.
            </div>
          </div>
          <div class="mt-4 grid grid-cols-2 gap-4">
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-500">Draft:</span>
              <span class="text-sm font-bold">
                <%= @draft_count || 0 %>
                <% 
                  # Safely calculate percentages, handling nil values
                  draft_count = @draft_count.to_i
                  in_progress_count = @in_progress_count.to_i
                  approved_count = @approved_count.to_i
                  rejected_count = @rejected_count.to_i
                  total = draft_count + in_progress_count + approved_count + rejected_count
                  if total > 0
                %>
                  (<%= number_to_percentage((draft_count.to_f / total) * 100, precision: 1) %>)
                <% end %>
              </span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-500">In Progress:</span>
              <span class="text-sm font-bold">
                <%= @in_progress_count || 0 %>
                <% if total > 0 %>
                  (<%= number_to_percentage((in_progress_count.to_f / total) * 100, precision: 1) %>)
                <% end %>
              </span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-500">Approved:</span>
              <span class="text-sm font-bold">
                <%= @approved_count || 0 %>
                <% if total > 0 %>
                  (<%= number_to_percentage((approved_count.to_f / total) * 100, precision: 1) %>)
                <% end %>
              </span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-500">Rejected:</span>
              <span class="text-sm font-bold">
                <%= @rejected_count || 0 %>
                <% if total > 0 %>
                  (<%= number_to_percentage((rejected_count.to_f / total) * 100, precision: 1) %>)
                <% end %>
              </span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>
