<%# 
  Dependent Information Form
  
  This partial provides dependent information with:
  - Personal identification
  - Contact information (with guardian fallback options)
  - Communication preferences
  - Guardian relationship type
%>

<fieldset id="dependent-info-section" class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm" data-controller="dependent-fields">
  <legend class="text-lg font-semibold text-gray-900 px-2">
    <% if mode == :edit && dependent.present? %>
      Dependent Information 
      <span class="text-sm font-normal text-indigo-600 ml-2">
        (Reviewing: <%= dependent.full_name %>)
      </span>
    <% else %>
      New Dependent Information
    <% end %>
  </legend>

  <% if mode == :edit && dependent.present? %>
    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md text-sm" role="status">
      <div class="flex items-start gap-2">
        <svg class="w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
        </svg>
        <div>
          <strong>Selected existing dependent:</strong> <%= dependent.full_name %>.
          <span class="block text-blue-700">Review and update their information below if needed.</span>
        </div>
      </div>
    </div>
  <% end %>

  <%= fields_for :constituent do |d| %>
    <%# ================================================================ %>
    <%# SECTION 1: Personal Identification %>
    <%# ================================================================ %>
    <div class="mb-6">
      <h3 class="text-base font-medium text-gray-800 mb-3 flex items-center gap-2">
        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        Dependent's Personal Information
      </h3>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <%= d.label :first_name, "First Name", class: "block text-sm font-medium text-gray-700", for: "dependent_constituent_first_name" %>
          <%= d.text_field :first_name, 
              id: "dependent_constituent_first_name",
              value: dependent&.first_name,
              required: true,
              autocomplete: "given-name",
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              "aria-required": "true",
              data: { "applicant-type-target": "dependentField" } %>
        </div>
        <div>
          <%= d.label :last_name, "Last Name", class: "block text-sm font-medium text-gray-700", for: "dependent_constituent_last_name" %>
          <%= d.text_field :last_name,
              id: "dependent_constituent_last_name", 
              value: dependent&.last_name,
              required: true,
              autocomplete: "family-name",
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              "aria-required": "true",
              data: { "applicant-type-target": "dependentField" } %>
        </div>
        <div>
          <%= d.label :date_of_birth, "Date of Birth", class: "block text-sm font-medium text-gray-700" %>
          <%= d.date_field :date_of_birth,
              id: "dependent_constituent_date_of_birth",
              required: true,
              autocomplete: "bday",
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              "aria-required": "true",
              "aria-describedby": "dependent_dob_hint",
              max: Date.current.to_s,
              data: { "applicant-type-target": "dependentField" } %>
          <% if mode == :edit && dependent.present? %>
            <p id="dependent_dob_hint" class="text-xs text-amber-600 mt-1">⚠️ Verify carefully before changing</p>
          <% else %>
            <p id="dependent_dob_hint" class="sr-only">Select date of birth</p>
          <% end %>
        </div>
      </div>
    </div>

    <%# ================================================================ %>
    <%# SECTION 2: Contact Information (with Guardian fallback) %>
    <%# ================================================================ %>
    <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200" data-controller="contact-feedback">
      <h3 class="text-base font-medium text-gray-800 mb-3 flex items-center gap-2">
        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
        </svg>
        Contact Information
      </h3>
      <p class="text-sm text-gray-600 mb-4">
        You can use the guardian's contact information or provide separate contact details for the dependent.
      </p>
      
      <%# Email Section %>
      <div class="mb-5 p-3 bg-white rounded border border-gray-200">
        <div class="flex items-start mb-3">
          <%= check_box_tag :use_guardian_email, "1", (dependent.blank? || dependent&.email.blank?), {
            id: "use_guardian_email_checkbox",
            class: "mt-1 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded", 
            data: { 
              dependent_fields_target: "sameEmailCheckbox",
              action: "change->dependent-fields#toggleEmailField"
            }
          } %>
          <label for="use_guardian_email_checkbox" class="ml-2">
            <span class="block text-sm font-medium text-gray-700">Use guardian's email address</span>
            <span class="block text-xs text-gray-500">Program communications will go to the guardian</span>
          </label>
        </div>
        
        <div class="ml-6 <%= 'hidden' if dependent.blank? || dependent&.email.blank? %>" data-dependent-fields-target="emailFieldContainer">
          <%= d.label :dependent_email, "Dependent's Email Address", class: "block text-sm font-medium text-gray-700" %>
          <%= d.email_field :dependent_email, 
              value: dependent&.email,
              autocomplete: "email",
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", 
              data: { 
                dependent_fields_target: "dependentEmail",
                "contact-feedback-target": "email"
              } %>
          <p class="mt-1 text-xs text-gray-500">This email will be used for communications about the dependent's benefits</p>
        </div>
      </div>
      
      <%# Phone Section %>
      <div class="mb-5 p-3 bg-white rounded border border-gray-200">
        <div class="flex items-start mb-3">
          <%= check_box_tag :use_guardian_phone, "1", (dependent.blank? || dependent&.phone.blank?), {
            id: "use_guardian_phone_checkbox",
            class: "mt-1 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded", 
            data: { 
              dependent_fields_target: "samePhoneCheckbox",
              action: "change->dependent-fields#togglePhoneField"
            }
          } %>
          <label for="use_guardian_phone_checkbox" class="ml-2">
            <span class="block text-sm font-medium text-gray-700">Use guardian's phone number</span>
            <span class="block text-xs text-gray-500">We'll call or text the guardian instead</span>
          </label>
        </div>
        
        <div class="ml-6 <%= 'hidden' if dependent.blank? || dependent&.phone.blank? %>" data-dependent-fields-target="phoneFieldContainer">
          <%= d.label :dependent_phone, "Dependent's Phone Number", class: "block text-sm font-medium text-gray-700" %>
          <%= d.telephone_field :dependent_phone, 
              value: dependent&.phone,
              autocomplete: "tel",
              placeholder: "XXX-XXX-XXXX",
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", 
              data: { 
                dependent_fields_target: "dependentPhone",
                "contact-feedback-target": "phone"
              } %>
        </div>
      </div>

      <%# Preferred Contact Method for Dependent %>
      <fieldset class="mb-4">
        <legend class="text-sm font-medium text-gray-700 mb-2">How would you like us to contact the dependent if we have any questions?</legend>
        <div role="radiogroup" aria-label="Contact preference" class="flex flex-wrap gap-4">
          <div class="flex items-center">
            <%= d.radio_button :phone_type, "voice", 
                id: "dependent_constituent_phone_type_voice", 
                class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300",
                data: { action: "change->contact-feedback#updateFeedback" } %>
            <%= d.label :phone_type_voice, "Call them", for: "dependent_constituent_phone_type_voice", class: "ml-2 text-sm text-gray-700" %>
          </div>
          <div class="flex items-center">
            <%= d.radio_button :phone_type, "text", 
                id: "dependent_constituent_phone_type_text", 
                class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300",
                data: { action: "change->contact-feedback#updateFeedback" } %>
            <%= d.label :phone_type_text, "Text them", for: "dependent_constituent_phone_type_text", class: "ml-2 text-sm text-gray-700" %>
          </div>
          <div class="flex items-center">
            <%= d.radio_button :phone_type, "videophone", 
                id: "dependent_constituent_phone_type_videophone", 
                class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300",
                data: { action: "change->contact-feedback#updateFeedback" } %>
            <%= d.label :phone_type_videophone, "Call using ASL (videophone)", for: "dependent_constituent_phone_type_videophone", class: "ml-2 text-sm text-gray-700" %>
          </div>
          <div class="flex items-center">
            <%= d.radio_button :phone_type, "email", 
                id: "dependent_constituent_phone_type_email", 
                class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300",
                data: { action: "change->contact-feedback#updateFeedback" } %>
            <%= d.label :phone_type_email, "Email them", for: "dependent_constituent_phone_type_email", class: "ml-2 text-sm text-gray-700" %>
          </div>
          <div class="flex items-center">
            <%= d.radio_button :phone_type, "letter", 
                id: "dependent_constituent_phone_type_letter", 
                class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300",
                data: { action: "change->contact-feedback#updateFeedback" } %>
            <%= d.label :phone_type_letter, "Send a letter", for: "dependent_constituent_phone_type_letter", class: "ml-2 text-sm text-gray-700" %>
          </div>
        </div>
        <div data-contact-feedback-target="feedback" class="hidden" aria-live="polite"></div>
      </fieldset>
      
      <%# Address Section %>
      <div class="p-3 bg-white rounded border border-gray-200">
        <div class="flex items-start mb-3">
          <%= check_box_tag :use_guardian_address, "1", (dependent.blank? || dependent&.physical_address_1.blank?), {
            id: "use_guardian_address_checkbox",
            class: "mt-1 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded", 
            data: { 
              dependent_fields_target: "sameAddressCheckbox",
              action: "change->dependent-fields#toggleContactFields"
            }
          } %>
          <label for="use_guardian_address_checkbox" class="ml-2">
            <span class="block text-sm font-medium text-gray-700">Same address as guardian</span>
            <span class="block text-xs text-gray-500">Dependent lives with guardian</span>
          </label>
        </div>
        
        <div class="ml-6 space-y-4 <%= 'hidden' if dependent.blank? || dependent&.physical_address_1.blank? %>" data-dependent-fields-target="addressFields">
          <div>
            <%= d.label :physical_address_1, "Street Address", class: "block text-sm font-medium text-gray-700", for: "dependent_constituent_physical_address_1" %>
            <%= d.text_field :physical_address_1, 
                id: "dependent_constituent_physical_address_1", 
                value: dependent&.physical_address_1,
                autocomplete: "address-line1",
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", 
                data: { dependent_fields_target: "dependentAddress1" } %>
          </div>
          <div>
            <%= d.label :physical_address_2, "Apt, suite, unit (optional)", class: "block text-sm font-medium text-gray-700", for: "dependent_constituent_physical_address_2" %>
            <%= d.text_field :physical_address_2, 
                id: "dependent_constituent_physical_address_2", 
                value: dependent&.physical_address_2,
                autocomplete: "address-line2",
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", 
                data: { dependent_fields_target: "dependentAddress2" } %>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="col-span-2">
              <%= d.label :city, "City", class: "block text-sm font-medium text-gray-700", for: "dependent_constituent_city" %>
              <%= d.text_field :city, 
                  id: "dependent_constituent_city", 
                  value: dependent&.city,
                  autocomplete: "address-level2",
                  class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", 
                  data: { dependent_fields_target: "dependentCity" } %>
            </div>
            <div>
              <%= d.label :state, "State", class: "block text-sm font-medium text-gray-700", for: "dependent_constituent_state" %>
              <%= d.text_field :state, 
                  id: "dependent_constituent_state", 
                  value: (dependent&.state || "MD"),
                  autocomplete: "address-level1",
                  class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", 
                  data: { dependent_fields_target: "dependentState" } %>
            </div>
            <div>
              <%= d.label :zip_code, "ZIP Code", class: "block text-sm font-medium text-gray-700", for: "dependent_constituent_zip_code" %>
              <%= d.text_field :zip_code, 
                  id: "dependent_constituent_zip_code", 
                  value: dependent&.zip_code,
                  autocomplete: "postal-code",
                  pattern: "[0-9]{5}(-[0-9]{4})?",
                  class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", 
                  data: { dependent_fields_target: "dependentZip" } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%# ================================================================ %>
    <%# SECTION 3: Communication & Accessibility Preferences %>
    <%# ================================================================ %>
    <div class="mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-100">
      <h3 class="text-base font-medium text-gray-800 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        Dependent's Communication Preferences
      </h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <%# Language Preference %>
        <div>
          <%= d.label :locale, "Preferred Language", class: "block text-sm font-medium text-gray-700 mb-1", for: "dependent_constituent_locale" %>
          <%= d.select :locale, 
              options_for_select([
                ["English", "en"], 
                ["Spanish", "es"], 
                ["French", "fr"], 
                ["American Sign Language (ASL)", "asl"],
                ["Other", "other"]
              ], dependent&.locale || "en"), 
              { prompt: "Select Language" }, 
              id: "dependent_constituent_locale",
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
        </div>

        <%# Preferred Communication Method (ASL, Written, etc.) %>
        <div>
          <%= d.label :preferred_means_of_communication, "How does the dependent prefer to communicate?", class: "block text-sm font-medium text-gray-700 mb-1", for: "dependent_constituent_preferred_comm" %>
          <%= d.select :preferred_means_of_communication, 
              options_for_select([
                ["Voice (spoken language)", "voice"],
                ["Read lips", "lip_reading"],
                ["American Sign Language (ASL)", "asl"],
                ["Signed English", "signed_english"],
                ["Written notes", "written"],
                ["Typed communication", "typed"],
                ["Braille", "braille"],
                ["Augmentative & Alternative Communication (AAC)", "aac"]
              ], dependent&.preferred_means_of_communication), 
              { prompt: "Select preference", include_blank: false }, 
              id: "dependent_constituent_preferred_comm",
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              "aria-describedby": "dependent_comm_method_hint" %>
          <p id="dependent_comm_method_hint" class="mt-1 text-xs text-gray-500">This helps us communicate in their preferred way</p>
        </div>
      </div>

      <%# Official Document Delivery Preference %>
      <fieldset class="mt-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-lg">
        <legend class="text-base font-semibold text-blue-900 mb-1 px-2">
          Where should we send official program documents?
        </legend>
        <p class="text-sm text-blue-700 mb-3 px-2">
          Important notices, approval letters, and voucher information will be delivered here
        </p>
        <div role="radiogroup" aria-label="Document delivery preference" class="flex flex-wrap gap-6">
          <div class="flex items-start">
            <%= d.radio_button :communication_preference, "email", 
                id: "dependent_constituent_communication_preference_email", 
                class: "mt-1 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300",
                data: { action: "change->contact-feedback#updateDeliveryFeedback" } %>
            <label for="dependent_constituent_communication_preference_email" class="ml-2">
              <span class="block text-sm font-medium text-gray-700">Email</span>
              <span class="block text-xs text-gray-500">Faster delivery, easy to save</span>
            </label>
          </div>
          <div class="flex items-start">
            <%= d.radio_button :communication_preference, "letter", 
                id: "dependent_constituent_communication_preference_letter", 
                class: "mt-1 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300",
                data: { action: "change->contact-feedback#updateDeliveryFeedback" } %>
            <label for="dependent_constituent_communication_preference_letter" class="ml-2">
              <span class="block text-sm font-medium text-gray-700">Printed letter by mail</span>
              <span class="block text-xs text-gray-500">Physical copy to your address</span>
            </label>
          </div>
        </div>
        <%# Live feedback for delivery method %>
        <div data-contact-feedback-target="deliveryFeedback" class="hidden" aria-live="polite"></div>
      </fieldset>
    </div>

    <%# ================================================================ %>
    <%# SECTION 4: How Did You Hear About Us %>
    <%# ================================================================ %>
    <div class="mb-4">
      <%= d.label :referral_source, "How did you hear about the MAT Program?", class: "block text-sm font-medium text-gray-700 mb-1", for: "dependent_constituent_referral_source" %>
      <%= d.select :referral_source, 
          options_for_select([
            ["Medical provider / Doctor's office", "medical_provider"],
            ["Social worker / Case manager", "social_worker"],
            ["State agency (DORS, MDOD, etc.)", "state_agency"],
            ["Community organization", "community_org"],
            ["Friend or family member", "friend_family"],
            ["Internet search", "internet"],
            ["Social media", "social_media"],
            ["Other", "other"]
          ], dependent&.referral_source), 
          { prompt: "Select an option (optional)", include_blank: true }, 
          id: "dependent_constituent_referral_source",
          class: "mt-1 block w-full rounded-md border-gray-300 bg-white shadow-sm ring-1 ring-inset ring-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 sm:text-sm" %>
    </div>
  <% end %>
  
  <%# ================================================================ %>
  <%# SECTION 5: Guardian Relationship Type %>
  <%# ================================================================ %>
  <div class="mt-6 p-4 bg-amber-50 rounded-lg border border-amber-200">
    <label for="relationship_type" class="block text-sm font-medium text-gray-700 mb-1">
      Guardian's Relationship to Dependent
      <span class="text-red-500" aria-hidden="true">*</span>
    </label>
    <select id="relationship_type" 
            name="relationship_type" 
            required
            class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" 
            aria-required="true"
            data-dependent-fields-target="relationshipType">
      <option value="">Select Relationship</option>
      <option value="Parent">Parent</option>
      <option value="Grandparent">Grandparent</option>
      <option value="Foster Parent">Foster Parent</option>
      <option value="Legal Guardian">Legal Guardian</option>
      <option value="Relative Caregiver">Relative Caregiver</option>
      <option value="Power of Attorney">Power of Attorney</option>
      <option value="Other">Other</option>
    </select>
    <p class="mt-1 text-xs text-gray-600">This helps us understand who is authorized to manage this application</p>
  </div>
</fieldset>
