# Authentication & Security

This document covers the complete authentication and security system in the MAT Vulcan application. The core authentication and 2FA functionalities (WebAuthn, TOTP, and SMS methods) are primarily implemented through code generated by the `authentication-zero` gem, which adheres to Rails best practices and security standards.

## Table of Contents
1. [Two-Factor Authentication Overview](#two-factor-authentication-overview)
2. [WebAuthn Implementation](#webauthn-implementation)
3. [TOTP (Authenticator Apps)](#totp-authenticator-apps)
4. [SMS Authentication](#sms-authentication)
5. [Testing Authentication](#testing-authentication)

---

## Two-Factor Authentication Overview

MAT Vulcan supports multiple 2FA methods to provide secure authentication while maintaining flexibility:

- **WebAuthn**: Security keys (YubiKeys) and platform authenticators (Touch ID, Windows Hello)
- **TOTP**: Time-based One-Time Password apps (Google Authenticator, Authy)
- **SMS**: Text message verification codes

### Standardized Session Management

The `TwoFactorVerification` concern in `app/controllers/concerns/two_factor_verification.rb` provides standardized session management for all authentication methods, along with the `TwoFactorAuth` module for centralized configuration.

#### Session Management Methods
```ruby
# Store a challenge in the session
store_challenge(type, challenge, metadata = {})

# Retrieve challenge data
challenge_data = retrieve_challenge
# Returns { type: :webauthn, challenge: '...', metadata: { ... } }

# Clear challenge after verification
clear_challenge

# Verification result methods
complete_verification(user_id, type)

# Logging helpers for auditing
log_verification_success(user_id, type, context = {})
log_verification_failure(user_id, type, error, context = {})
```

#### Unified Verification Interface
```ruby
# Verify any credential type
verify_credential(type, params)
# Supports :webauthn, :totp, :sms

# Type-specific verification methods
verify_webauthn_credential(params)
verify_totp_credential(code)
verify_sms_credential(code, credential_id)
```

---

## WebAuthn Implementation

WebAuthn provides the highest security level using cryptographic authenticators.

### Configuration

WebAuthn is configured in `config/initializers/webauthn.rb`:

```ruby
WebAuthn.configure do |config|
  config.allowed_origins = [ENV["WEBAUTHN_ORIGIN"]]
  config.rp_name = "MAT Vulcan"
end
```

**Important**: `WEBAUTHN_ORIGIN` must match your application's domain (e.g., `https://your-app-domain.com`). In development, set to `http://localhost:3000`.

### Registration Flow

1. **Generate Credential Options** (`WebAuthnCredentialsController#options`)
2. **Store Challenge** with `TwoFactorAuth.store_challenge`
3. **Create Credential** with browser API (`credential.js#create`)
4. **Verify Challenge** and save credential

### Authentication Flow

1. **Generate Assertion Options** (`WebAuthnCredentialAuthenticationsController#options`)
2. **Store Challenge** with `TwoFactorAuth.store_challenge`
3. **Get Assertion** with browser API (`credential.js#get`)
4. **Verify Challenge** and mark session as verified

### Backend Implementation

#### WebauthnCredential Model
Stores user's WebAuthn credentials:
- `external_id`: Credential ID from authenticator
- `public_key`: Credential's public key for verification
- `nickname`: User-friendly name
- `sign_count`: Counter to prevent replay attacks

#### Controllers
- `TwoFactorAuthenticationsController`: Manages the overall 2FA flow, including WebAuthn, TOTP, and SMS. Specific WebAuthn credential creation and authentication logic is integrated within this controller or related generated components.

#### Example Controller Usage
```ruby
# Store challenge during credential creation
store_challenge(
  :webauthn,
  create_options.challenge,
  { authenticator_type: authenticator_type }
)

# Retrieve and verify challenge during authentication
challenge_data = retrieve_challenge
challenge = challenge_data[:challenge]
webauthn_credential.verify(challenge)

# Clear challenge and mark as verified
clear_challenge
complete_verification(user.id, :webauthn)
```

### Frontend Implementation

#### JavaScript Integration
The `auth.js` module (or similar generated JavaScript) provides unified functions for WebAuthn, TOTP, and SMS operations:

```javascript
// WebAuthn operations (functions may be within auth.js or other generated files)
create(callbackUrl, credentialOptions, feedbackElement)
get(credentialOptions, callbackUrl, feedbackElement)

// TOTP verification
verifyTotpCode(code, callbackUrl, feedbackElement)

// SMS operations
verifySmsCode(code, callbackUrl, feedbackElement)
requestSmsCode(url, feedbackElement)
```

#### Stimulus Controllers
- `add_credential_controller.js`: Handles credential creation
- `credential_authenticator_controller.js`: Handles authentication

---

## TOTP (Authenticator Apps)

TOTP uses time-based codes that change every 30 seconds.

### Registration Flow

1. **Generate TOTP Secret** (`TotpCredentialsController#new`)
2. **Store Secret** in session with `TwoFactorAuth.store_challenge`
3. **Display QR Code** for user to scan
4. **Verify Initial Code** and save credential

### Authentication Flow

1. **User Enters Code** from authenticator app
2. **Verify Code** against stored secrets (`verify_totp_code`)
3. **Mark Session** as verified

### Implementation Example

```ruby
def verify_code
  method = params[:method]
  code = params[:code]
  
  if method == 'totp'
    result = verify_totp_credential(code)
  elsif method == 'sms'
    result = verify_sms_credential(code, params[:credential_id])
  end
  
  if result.first # result is [success, message]
    complete_verification(current_user.id, method.to_sym)
    redirect_to stored_location_for(:user) || root_path
  else
    flash.now[:alert] = result.last
    render :verify
  end
end
```

---

## SMS Authentication

SMS sends verification codes to the user's phone.

### Registration Flow

1. **Collect Phone Number** (`TwoFactorAuthenticationsController#create_credential`)
2. **Create SMS Credential** with phone number validation
3. **Generate and Send Code** via `SmsService`
4. **Store Code Digest** with expiration time
5. **Verify Code** entered by user

### Authentication Flow

1. **Generate and Send Code** to user's registered phone
2. **Store Code Digest** with `store_challenge`
3. **Verify Code** using `verify_sms_credential`
4. **Mark Session** as verified with `complete_verification`

### Security Considerations

- Codes expire after a short time period
- Rate limiting prevents abuse
- Code digests are stored, not plain text codes
- SMS delivery failures are handled gracefully

---

## Testing Authentication

### Test Files

- `test/lib/two_factor_auth_test.rb`: Core session management methods
- `test/controllers/two_factor_authentication_webauthn_test.rb`: WebAuthn credential creation and authentication controller tests
- `test/system/webauthn_sign_in_test.rb`: WebAuthn sign-in flow
- `test/system/two_factor_authentication_flow_test.rb`: Overall 2FA flow

### WebAuthn Testing

Use the `WebauthnTestHelper` module:

```ruby
include WebauthnTestHelper

def setup
  @fake_client = setup_webauthn_test_environment
end
```

### Testing Best Practices

- **WebAuthn**: Use fake client to simulate authentication without browser interactions
- **TOTP**: Use fixed codes in tests and mock time-based generation
- **SMS**: Mock SMS service and use predictable codes
- **Focus on Logic**: Test credential creation/verification logic rather than complex browser interactions

### System Test Approach

1. **Credential Creation**: Test that credentials can be created and associated with users
2. **Credential Verification**: Test that credentials are properly verified
3. **User Status**: Test that user's second factor status is updated correctly
4. **Error Handling**: Test various failure scenarios

---

## Security Features

### Session Security
- Challenges are stored temporarily and cleared after use
- Session verification timestamps prevent replay attacks
- All authentication attempts are logged for auditing

### Rate Limiting
- Failed authentication attempts are rate limited
- SMS code requests are rate limited to prevent abuse
- WebAuthn challenges have expiration times

### Audit Trail
- All verification attempts (success/failure) are logged
- User authentication events are tracked
- Security-relevant actions include user context

### Error Handling
- Consistent error messages across all authentication methods
- Graceful handling of device/service unavailability
- Clear user feedback for authentication issues

---

## Troubleshooting

### Common Issues

1. **WebAuthn Origin Mismatch**: Ensure `WEBAUTHN_ORIGIN` matches your domain exactly
2. **TOTP Time Sync**: Verify server and client clocks are synchronized
3. **SMS Delivery**: Check SMS service configuration and rate limits
4. **Session Issues**: Verify session storage and cleanup

### Debugging Tools

- Check authentication logs for detailed error messages
- Use browser developer tools for WebAuthn debugging
- Verify environment variables are set correctly
- Test with multiple devices/browsers for compatibility

### Best Practices

- Always use HTTPS in production for WebAuthn
- Implement proper error handling for all authentication methods
- Provide clear user instructions for each authentication method
- Test authentication flows regularly across different devices
