# Paper Application Attachment Fix (HISTORICAL DOCUMENT)

**Note: This document describes an older approach that has been replaced by our standardized attachment process. See [Proof Attachment Standardization](proof_attachment_standardization.md) for the current implementation.**

## Issue Summary

When submitting paper applications, the file uploads for income proof and residency proof were not being properly attached to the application. The logs showed the following sequence:

1. Files were being properly uploaded to ActiveStorage
2. The controller received the signed blob IDs in the parameters
3. The service class failed to decode and attach the blobs to the application
4. Applications were being created without the required attachments

The issue was specifically with how the blob IDs were being decoded and located in the `process_proof` method of the `PaperApplicationService`.

## Root Cause

The root cause was an incomplete blob resolution strategy in the `PaperApplicationService`. The service was trying to:

1. First try to use `GlobalID::Locator.locate_signed` to find the blob
2. If that failed, attempt manual extraction of the blob ID via regex

However, this approach was missing a critical step: trying `ActiveStorage::Blob.find_signed`, which is Rails' standard method for resolving signed blob references. This was causing the resolution to fail in certain scenarios, especially when handling the format used in direct uploads.

## Fix Implementation

The fix enhances the blob resolution process with a more comprehensive strategy:

1. First try `ActiveStorage::Blob.find_signed` (the Rails standard method)
2. If that fails, try `GlobalID::Locator.locate_signed` (the previous approach)
3. If that still fails, fall back to manual extraction

This creates a more robust resolution chain that can handle different formats of blob references, including those generated by direct uploads.

## Testing

To test this fix:

1. Submit a new paper application with file uploads
2. Verify that the files are properly attached to the application
3. View the application details to confirm the attachments are visible and downloadable

## Potential Future Improvements

- Add more detailed logging around blob resolution to make debugging easier
- Consider adding a service method that standardizes blob resolution across the application
- Implement more comprehensive error handling for attachment failures
- Add systematic tests that verify attachment functionality with different blob reference formats
